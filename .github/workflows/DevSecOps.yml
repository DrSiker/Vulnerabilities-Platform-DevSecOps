name: DevSecOps CI/CD

on:
  push:
    paths:
      - 'app-vulnerable/**'
  # pull_request:
  #   paths:
  #     - 'app-vulnerable/**'

jobs:
  security-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          pip install -r app-vulnerable/requirements.txt

      # 游댌 **Escaneo SAST (C칩digo Est치tico)**
      - name: Run SAST (Bandit)
        run: |
          pip install bandit
          bandit -r app-vulnerable/src/ | tee bandit_report.txt

      # - name: Run SAST (SonarQube)
      #   env:
      #     SONAR_HOST_URL: "https://your-sonarqube-instance"
      #     SONAR_TOKEN: "your-token"
      #   run: |
      #     sonar-scanner -Dsonar.projectKey=app-vulnerable -Dsonar.sources=app-vulnerable/src/ -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN

      # 游댌 **Escaneo de Dependencias (SCA)**
      - name: Run SCA (JFrog Xray)
        env:
          JFROG_URL: "https://your-jfrog-instance"
          JFROG_USER: "your-username"
          JFROG_PASSWORD: "your-password"
        run: |
          curl -u $JFROG_USER:$JFROG_PASSWORD -X POST "$JFROG_URL/xray/api/v1/scanArtifact" \
          -H "Content-Type: application/json" --data '{"artifact": "app-vulnerable/requirements.txt"}' | tee jfrog_report.txt
      
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.46.0_Linux-64bit.tar.gz
          tar -xvf trivy_0.46.0_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      - name: Run SCA (Trivy)
        run: |
          trivy fs --scanners vuln,secret app-vulnerable/ > trivy_report.txt

      # 游댌 **Escaneo Din치mico (DAST)**
      - name: Run DAST (OWASP ZAP)
        uses: zaproxy/action-full-scan@v0.5.0
        with:
          target: 'http://localhost:8080'
        continue-on-error: true

      # 游댌 **Escaneo de Im치genes Docker**
      - name: Run Container Scan (Trivy)
        run: |
          trivy image vulnerabilities-platform-devsecops-app-vulnerable:latest > trivy_docker_report.txt

      # 游늵 **Procesamiento de Reportes**
      - name: Parse Reports and Send to Backend
        run: |
          echo "{" > vulnerabilities.json
          echo "  \"SAST\": " >> vulnerabilities.json
          cat bandit_report.txt | jq -R -s '.' >> vulnerabilities.json
          echo "," >> vulnerabilities.json
          echo "  \"SCA\": " >> vulnerabilities.json
          cat jfrog_report.txt | jq -R -s '.' >> vulnerabilities.json
          echo "," >> vulnerabilities.json
          echo "  \"Trivy\": " >> vulnerabilities.json
          cat trivy_report.txt | jq -R -s '.' >> vulnerabilities.json
          echo "}" >> vulnerabilities.json

          echo "Sending vulnerabilities to backend..."
          curl -X POST "http://localhost:5000/vulnerabilities" \
          -H "Content-Type: application/json" \
          -d @vulnerabilities.json
