name: DevSecOps Pipeline

on:
  push:
    paths:
      - 'app-vulnerable/**'
  # pull_request:
  #   paths:
  #     - 'app-vulnerable/**'

jobs:
  security-scans:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Paso 1: Instalar dependencias
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install bandit
          sudo apt-get install -y wget unzip

      # Paso 2: Ejecutar Bandit (SAST)
      - name: Run Bandit (SAST)
        run: |
          bandit -r app-vulnerable/src/ -f json -o bandit_report.json
          echo "Bandit report generated."

      # Paso 3: Ejecutar Dependency-Check (SCA)
      - name: Run Dependency-Check (SCA)
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.2.1/dependency-check-8.2.1-release.zip
          unzip dependency-check-8.2.1-release.zip
          ./dependency-check/bin/dependency-check.sh --project "Vulnerabilities-Platform" --scan . --format JSON --out dependency-check-report.json
          echo "Dependency-Check report generated."

      # Paso 4: Enviar reportes al backend
      - name: Send Bandit Report to Backend
        run: |
          echo "Sending Bandit report to backend..."
          curl -X POST "http://vulnerabilities-platform-devsecops-backend-1:5000/vulnerabilities" \
          -H "Content-Type: application/json" \
          -d '{"tool": "Bandit", "report": '$(cat bandit_report.json)'}'

      - name: Send Dependency-Check Report to Backend
        run: |
          echo "Sending Dependency-Check report to backend..."
          curl -X POST "http://vulnerabilities-platform-devsecops-backend-1:5000/vulnerabilities" \
          -H "Content-Type: application/json" \
          -d '{"tool": "Dependency-Check", "report": '$(cat dependency-check-report.json)'}'